# act-runner-scale-set values
# Each installation of this chart creates one runner scale set.

# -- (required) Gitea instance URL (e.g. https://gitea.example.com)
giteaConfigUrl: ""

# -- Authentication secret for runner registration.
# Can be specified as:
#   1. A map with token (chart creates the Secret):
#        giteaConfigSecret:
#          token: "your-registration-token"
#   2. A map with name (reference pre-existing Secret):
#        giteaConfigSecret:
#          name: "my-existing-secret"
#   3. A string (shorthand for pre-existing Secret name):
#        giteaConfigSecret: "my-existing-secret"
giteaConfigSecret:
  # -- Registration token (will be stored in a chart-managed Secret)
  token: ""
  # -- Name of a pre-existing Secret containing the token in a key called "token"
  name: ""

# -- Runner scale set name. Used as the runner name prefix.
# Defaults to the Helm release name.
runnerScaleSetName: ""

# -- Runner labels (comma-separated).
# Example: "ubuntu-latest:docker://node:20,self-hosted"
# Leave empty for defaults.
runnerLabels: ""

# -- Number of runner replicas
replicas: 1

# -- Maximum number of runner replicas (for HPA)
maxRunners: 10

# -- Minimum number of runner replicas (for HPA)
minRunners: 1

# -- Enable Horizontal Pod Autoscaler
autoscaling:
  enabled: false
  # -- Min replicas for HPA
  minReplicas: 1
  # -- Max replicas for HPA
  maxReplicas: 10
  # -- Target CPU utilization for scaling
  targetCPUUtilizationPercentage: 80
  # -- Target memory utilization for scaling
  # targetMemoryUtilizationPercentage: 80

# -- Run as ephemeral runner (runner exits after one job)
ephemeral: false

image:
  # -- Runner image repository
  repository: ghcr.io/00o-sh/act_runner
  # -- Image pull policy
  pullPolicy: IfNotPresent
  # -- Image tag override (defaults to chart appVersion with variant suffix)
  tag: ""

# -- Image pull secrets
imagePullSecrets: []

# -- Override the chart name
nameOverride: ""
# -- Override the full release name
fullnameOverride: ""

# Container mode configuration
# The runner image tag is automatically set based on the container mode type:
#   "" (basic): uses the default image tag
#   "dind": uses image tag with "-dind" suffix (includes Docker daemon via s6)
#   "dind-rootless": uses image tag with "-dind-rootless" suffix
containerMode:
  # -- Container mode type: "dind", "dind-rootless", or "" (basic/host docker socket)
  type: ""

# -- Mount the host Docker socket instead of using DinD.
# Only used when containerMode.type is empty.
hostDockerSocket:
  enabled: false
  path: /var/run/docker.sock

# Runner configuration file content (YAML).
# If empty, the runner uses its built-in defaults.
# Use act_runner generate-config to see all options.
runnerConfig: ""
  # Example:
  # log:
  #   level: info
  # runner:
  #   file: .runner
  #   capacity: 1
  #   timeout: 3h
  # container:
  #   network: ""
  #   privileged: false

serviceAccount:
  # -- Create a service account for runner pods
  create: true
  # -- Annotations for the service account
  annotations: {}
  # -- Service account name override
  name: ""

# -- Additional labels to add to all resources
additionalLabels: {}

# -- Additional annotations to add to all resources
additionalAnnotations: {}

# -- Pod-level annotations
podAnnotations: {}

# -- Pod-level security context
podSecurityContext: {}

# -- Container-level security context (runner container)
securityContext: {}

resources: {}
  # limits:
  #   cpu: "2"
  #   memory: 4Gi
  # requests:
  #   cpu: 500m
  #   memory: 1Gi

# Persistent storage for runner data
persistence:
  # -- Enable persistent storage for runner registration data
  enabled: true
  # -- Storage class (empty = default)
  storageClass: ""
  # -- Access mode
  accessMode: ReadWriteOnce
  # -- Storage size
  size: 1Gi

# -- Node selector for runner pods
nodeSelector: {}

# -- Tolerations for runner pods
tolerations: []

# -- Affinity rules for runner pods
affinity: {}

# -- Priority class for runner pods
priorityClassName: ""

# -- Extra environment variables for the runner container
extraEnv: []
  # - name: CUSTOM_VAR
  #   value: "custom-value"

# -- Extra volume mounts for the runner container
extraVolumeMounts: []

# -- Extra volumes for the pod
extraVolumes: []

# -- TLS configuration for Gitea server
giteaServerTLS:
  # -- Name of a ConfigMap containing a CA certificate
  certificateFrom:
    configMapRef:
      name: ""
      key: "ca.crt"

# KEDA-based job-aware autoscaling configuration.
# Requires KEDA to be installed in the cluster and the act-runner-controller
# chart to provide TriggerAuthentication.
# See https://keda.sh/docs/latest/deploy/ for KEDA installation.
keda:
  # -- Enable KEDA for job-aware autoscaling.
  #    KEDA mode depends on the `ephemeral` setting:
  #      ephemeral=false → ScaledObject: scales Deployment/StatefulSet replicas up/down
  #      ephemeral=true  → ScaledJob: creates one Kubernetes Job per pending workflow job
  #    ScaledJob is recommended for ephemeral runners (clean 1:1 mapping).
  enabled: false

  # -- Name of the KEDA TriggerAuthentication resource (created by act-runner-controller chart).
  #    This references the Secret containing the Forgejo API token.
  triggerAuthenticationRef: ""

  # -- Full URL to the Forgejo/Gitea jobs API endpoint that KEDA will poll.
  #    KEDA reads the JSON response and extracts `valueLocation` to determine pending jobs.
  #
  #    Forgejo example: https://forgejo.example.com/api/v1/admin/runners/jobs?status=waiting&limit=1
  #    Gitea example:   https://gitea.example.com/api/v1/admin/actions/jobs?status=waiting&limit=1
  #    Org-scoped:      https://forgejo.example.com/api/v1/orgs/my-org/actions/jobs?status=waiting&limit=1
  metricsUrl: ""

  # -- JSON path in the API response that holds the pending job count.
  #    Default "total_count" works with standard Forgejo/Gitea list endpoints.
  valueLocation: "total_count"

  # -- How often (seconds) KEDA checks for pending jobs
  pollingInterval: 30

  # -- How long (seconds) to wait after last trigger before scaling to minRunners
  cooldownPeriod: 300

  # -- Skip TLS verification for the Forgejo API (not recommended for production)
  unsafeSsl: false

  # ScaledJob-specific settings (only used when keda.enabled=true AND ephemeral=true).
  # When ephemeral is true, KEDA creates a Kubernetes Job per pending workflow job
  # instead of scaling a Deployment. Each Job runs one runner, completes, and exits.
  scaledJob:
    # -- Seconds to keep completed Jobs before automatic cleanup
    ttlSecondsAfterFinished: 300
    # -- Number of successful Jobs to retain in history
    successfulJobsHistoryLimit: 5
    # -- Number of failed Jobs to retain in history
    failedJobsHistoryLimit: 5
    # -- KEDA scaling strategy: "default", "custom", or "accurate"
    #    default:  KEDA decides how many jobs to create per polling cycle
    #    accurate: creates exactly one Job per pending workflow job
    #    custom:   advanced custom formula (see KEDA docs)
    scalingStrategy: ""

# -- HTTP proxy configuration
proxy:
  http: ""
  https: ""
  noProxy: ""
